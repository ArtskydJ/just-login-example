<!doctype html>
<!-- Created with GFM2HTML: https://github.com/rvagg/gfm2html -->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="created-with" content="https://github.com/rvagg/gfm2html">

    <style src="css/markdown-style.css" type="text/css"></style>
  </head>
  <body>
    <div class="container">
      <div class="body-content"><h1 id="authentication">Authentication</h1>
<p>So you&#39;re making a site where users need to be authenticated to use its cool service. And you want to use a javascript module to do the authentication stuff.</p>
<p>Do you really want to have passwords? <a href="https://medium.com/@ninjudd/lets-boycott-passwords-680d97eddb01">Skip passwords!</a> Think about the advantages:</p>
<ol>
<li><a href="http://blog.moertel.com/posts/2006-12-15-never-store-passwords-in-a-database.html">Identities</a> <a href="http://heartbleed.com/">won&#39;t</a> <a href="https://en.wikipedia.org/wiki/SQL_injection#Examples">get</a> <a href="http://readwrite.com/2009/12/16/rockyou_hacker_30_of_sites_store_plain_text_passwords">comprimised</a> <a href="http://www.net-security.org/secworld.php?id=8612">so</a> <a href="http://en.blog.wordpress.com/2014/09/12/gmail-password-leak-update/">easily.</a></li>
<li><a href="https://medium.com/@ninjudd/passwords-are-obsolete-9ed56d483eb">You don&#39;t need them</a>.</li>
<li>Easier frontend. (None of those ridiculous <code>Registration</code> or <code>Forgot your Password</code> pages.)</li>
<li>You will probably get more users. (I always hate signing up for another site.)</li>
<li>Users are dumb; they&#39;ll use <code>123456</code> or reuse a password.</li>
<li>The tokens are basically impossible to guess, and expire shortly. (In this case, the token is an UUID and expires in just 5 minutes.)</li>
</ol>
<h1 id="how-just-login-works-without-passwords">How Just-Login works without passwords</h1>
<p>A guy named Todd goes to a site using just-login. He types his email address into the email field and clicks <code>Login</code>.</p>
<p>When the <code>Login</code> button is pressed, the core generates a unique token, and saves Todd&#39;s session id and email address under it. The core then emits an event, <code>&#39;authentication initiated&#39;</code>. The core will delete the token after a set time. </p>
<p>When the emailer is sees an <code>&#39;authentication initiated&#39;</code> event, it emails Todd, and says something like this:</p>
<pre><code>Hey, to login, click this:
http://example.com/login?token=1234567890qwertyuiopasdfghjkl
If you didn&#39;t mean to log in, ignore this email.</code></pre>
<p>Todd receives the email and clicks on the link, which sends his token to the site.</p>
<p>Look up the token in the user database.</p>
<p>If the token is NOT there, say: &quot;FAILURE! Maybe you waited too long, or clicked an old link.&quot;</p>
<p>If the token IS there, authenticate the session id associated with the token. (It will, of course, be Todd&#39;s record.) Delete the token.</p>
<p>Todd has effectively authenticated himself via his email address.</p>
<p>PROFIT!!!</p>
<h1 id="overview-of-each-just-login-module">Overview of each just-login module</h1>
<p>J.L. = Just Login</p>
<h3 id="diagram">Diagram</h3>
<pre><code>┌─────────────────┐             ┌───────┐             ┌─────────────────┐
│ Example  Server ├─────────────┤ Dnode ├─────────────┤ Example  Client │
└────────┬────────┘             └───────┘             └────────┬────────┘
┌────────┴────────┐                                     ┌──────┴──────┐
│ J.L. Server API │                                     │ J.L. Client │
└────────┬────────┘                                     └─────────────┘
 ┌───────┴──────────────────────────┐
 │         [Debounced Core]         │
 │ ┌───────────┐ ┌────────────────┐ │ ┌──────────────┐
 │ │ J.L. Core ├─┤ J.L. Debouncer │ ├─┤ J.L. Emailer │
 │ └───────────┘ └────────────────┘ │ └──────────────┘
 └───────┬──────────────────────────┘
    ┌────┴────┐
    │ LevelUP │
    └─────────┘</code></pre>
<h3 id="server-sample-code">Server Sample Code</h3>
<div class="highlight"><pre><span class="c1">//Just Login</span>
<span class="kd">var</span> <span class="nx">JlCore</span> <span class="o">=</span>      <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;just-login-core&#39;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">JlDebouncer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;just-login-debouncer&#39;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">JlServerApi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;just-login-server-api&#39;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">JlEmailer</span> <span class="o">=</span>   <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;just-login-emailer&#39;</span><span class="p">)</span>

<span class="c1">//Other</span>
<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">dnode</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;dnode&#39;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">shoe</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;shoe&#39;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">Static</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;node-static&#39;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">level</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">)</span>

<span class="c1">//Create a few databases</span>
<span class="kd">var</span> <span class="nx">coreDb</span> <span class="o">=</span> <span class="nx">level</span><span class="p">(</span><span class="s1">&#39;./databases/core&#39;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">debounceDb</span> <span class="o">=</span> <span class="nx">level</span><span class="p">(</span><span class="s1">&#39;./databases/debouncer&#39;</span><span class="p">)</span>

<span class="c1">//Set up just-login</span>
<span class="kd">var</span> <span class="nx">core</span> <span class="o">=</span> <span class="nx">JlCore</span><span class="p">(</span><span class="nx">coreDb</span><span class="p">)</span>
<span class="nx">justLoginDebouncer</span><span class="p">(</span><span class="nx">core</span><span class="p">)</span> <span class="c1">//Modifies &#39;core&#39;</span>
<span class="kd">var</span> <span class="nx">serverApi</span> <span class="o">=</span> <span class="nx">JlServerApi</span><span class="p">(</span><span class="nx">jlc</span><span class="p">)</span>

<span class="c1">//Set up just-login-emailer</span>
<span class="kd">function</span> <span class="nx">htmlEmail</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;Copy and paste this into your browser\&#39;s address bar: http://example.com/login?token=&#39;</span> <span class="o">+</span> <span class="nx">token</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">transportOptions</span> <span class="o">=</span> <span class="p">{</span> <span class="c1">//if using gmail sending server</span>
    <span class="nx">host</span><span class="o">:</span> <span class="s2">&quot;smtp.gmail.com&quot;</span><span class="p">,</span>
    <span class="nx">port</span><span class="o">:</span> <span class="mi">465</span><span class="p">,</span>
    <span class="nx">secure</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">auth</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">user</span><span class="o">:</span> <span class="s2">&quot;justloginexample@gmail.com&quot;</span><span class="p">,</span>
        <span class="nx">pass</span><span class="o">:</span> <span class="s2">&quot;whatever the password is&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">mailOptions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">from</span><span class="o">:</span> <span class="s1">&#39;whomever@example.com&#39;</span><span class="p">,</span>
    <span class="nx">subject</span><span class="o">:</span> <span class="s1">&#39;login now&#39;</span>
<span class="p">}</span>

<span class="nx">JlEmailer</span><span class="p">(</span><span class="nx">core</span><span class="p">,</span> <span class="nx">htmlEmail</span><span class="p">,</span> <span class="nx">transportOptions</span><span class="p">,</span> <span class="nx">mailOptions</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1">//Set up your server</span>
<span class="kd">var</span> <span class="nx">DNODE_ENDPOINT</span> <span class="o">=</span>  <span class="s2">&quot;/dnode&quot;</span>
<span class="kd">var</span> <span class="nx">TOKEN_ENDPOINT</span> <span class="o">=</span>  <span class="s2">&quot;/login&quot;</span>
<span class="kd">var</span> <span class="nx">STATIC_DIR</span> <span class="o">=</span> <span class="s2">&quot;./static/&quot;</span>

<span class="kd">var</span> <span class="nx">fileServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Static</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="nx">STATIC_DIR</span><span class="p">,</span> <span class="p">{</span><span class="nx">gzip</span><span class="o">:</span> <span class="kc">true</span><span class="p">})</span>

<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span> <span class="nx">requestListener</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">parsedUrl</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="c1">//queryString enabled</span>
    <span class="kd">var</span> <span class="nx">pathname</span> <span class="o">=</span> <span class="nx">parsedUrl</span><span class="p">.</span><span class="nx">pathname</span>
    <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">parsedUrl</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">token</span>

    <span class="kd">function</span> <span class="nx">serve</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">statusCode</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="nx">path</span> <span class="o">+=</span> <span class="s2">&quot;index.html&quot;</span>
        <span class="nx">fileServer</span><span class="p">.</span><span class="nx">serveFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">statusCode</span> <span class="o">||</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">headers</span><span class="p">)</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">pathname</span> <span class="o">===</span> <span class="nx">TOKEN_ENDPOINT</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">core</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span>        <span class="nx">serve</span><span class="p">(</span><span class="s1">&#39;loginFailure.html&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">addr</span><span class="p">)</span> <span class="nx">serve</span><span class="p">(</span><span class="s1">&#39;loginFailure.html&#39;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
            <span class="k">else</span>            <span class="nx">serve</span><span class="p">(</span><span class="s1">&#39;loginSuccess.html&#39;</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">DNODE_ENDPOINT</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">DNODE_ENDPOINT</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//not dnode</span>
        <span class="nx">serve</span><span class="p">(</span><span class="nx">pathname</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="c1">//Expose API to user via Dnode</span>
<span class="nx">shoe</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">dnode</span><span class="p">(</span><span class="nx">serverApi</span><span class="p">)</span>
    <span class="nx">d</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">stream</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>
<span class="p">}).</span><span class="nx">install</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="nx">DNODE_ENDPOINT</span><span class="p">)</span>
</pre></div>

<h3 id="what-you-need-for-your-website">What you need for your Website</h3>
<p>To use Just-Login, you only <strong>need</strong> the <a href="https://github.com/coding-in-the-wild/just-login-core">Core</a>. But it makes a lot of sense to also use the <a href="https://github.com/coding-in-the-wild/just-login-server-api">Server API</a>.</p>
<p>The <a href="https://github.com/coding-in-the-wild/just-login-core"><code>Core</code></a> is an event emitter that has some functions as properties. The functions are for logging you in or out, and checking if you&#39;re logged in.</p>
<p>The <a href="https://github.com/coding-in-the-wild/just-login-server-api"><code>Server API</code></a> takes a core. It returns two functions, one to continue and existing session, and one to create a new one. After a session is established, it gives back function for logging you in or out, and checking if you&#39;re logged in. The difference from the core, is that a session is bound to each function given back.</p>
<p>The <a href="https://github.com/coding-in-the-wild/just-login-debouncer"><code>Debouncer</code></a> disallows <code>core.beginAuthentication()</code> to be called in too quick of succession.</p>
<h1 id="sending-the-token">Sending the Token</h1>
<p>If you plan to email the user, you might as well use the <a href="https://github.com/coding-in-the-wild/just-login-emailer">Emailer</a>.</p>
<p>If you want to use something else, you&#39;ll have to write a bit of code. See the example below:</p>
<div class="highlight"><pre><span class="nx">core</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;authentication initiated&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">loginRequest</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">//replace &#39;sendMessage&#39; with whatever function you have for sending a message to the user.</span>
    <span class="nx">sendMessage</span><span class="p">(</span><span class="nx">loginRequest</span><span class="p">.</span><span class="nx">contactAddress</span><span class="p">,</span> <span class="s1">&#39;Here is your login code:\n&#39;</span> <span class="o">+</span> <span class="nx">loginRequest</span><span class="p">.</span><span class="nx">token</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>

</div>
    </div>
  </body>
</html>